#!/bin/bash
# kubctl-0x01
# Objective: Scale Django app in Kubernetes and test performance

set -e

DEPLOYMENT_NAME="messaging-app-deployment"
SERVICE_NAME="messaging-app-service"
NAMESPACE="default"
PORT=8000
URL="http://127.0.0.1:${PORT}"

echo "Scaling $DEPLOYMENT_NAME to 3 replicas..."
kubectl scale deployment $DEPLOYMENT_NAME --replicas=3 --namespace=$NAMESPACE

echo "Waiting for pods to be ready..."
kubectl rollout status deployment/$DEPLOYMENT_NAME --namespace=$NAMESPACE

echo "Current Pods:"
kubectl get pods --namespace=$NAMESPACE -o wide

echo "Setting up port-forward to access service..."
# Kill any previous port-forward running
pkill -f "kubectl port-forward service/$SERVICE_NAME" || true
kubectl port-forward service/$SERVICE_NAME $PORT:$PORT --namespace=$NAMESPACE >/dev/null 2>&1 &
sleep 5

echo "Running load test with wrk..."
wrk -t4 -c100 -d30s $URL

echo "Monitoring resource usage (CPU/Memory):"
kubectl top pods --namespace=$NAMESPACE

echo "Done. Your app has been scaled and tested."
